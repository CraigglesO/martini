!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).Martin=e()}(this,function(){"use strict";class t{constructor(t,e){const i=e.gridSize;if(t.length!==i*i)throw new Error(`Expected terrain data of length ${i*i} (${i} x ${i}), got ${t.length}.`);this.terrain=t,this.martin=e,this.errors=new Float32Array(t.length),this.update()}update(){const{numTriangles:t,numParentTriangles:e,coords:i,gridSize:r}=this.martin,{terrain:n,errors:s}=this;for(let o=t-1;o>=0;o--){const t=4*o,a=i[t+0],c=i[t+1],h=i[t+2],d=i[t+3],l=a+h>>1,u=c+d>>1,f=l+u-c,g=u+a-l,m=(n[c*r+a]+n[d*r+h])/2,w=u*r+l,p=Math.abs(m-n[w]);if(s[w]=Math.max(s[w],p),o<e){const t=(c+g>>1)*r+(a+f>>1),e=(d+g>>1)*r+(h+f>>1);s[w]=Math.max(s[w],s[t],s[e])}}}getMesh(t=0){const{gridSize:e,indices:i}=this.martin,{errors:r}=this;let n=0,s=0;const o=e-1;function a(o,c,h,d,l,u){const f=o+h>>1,g=c+d>>1;Math.abs(o-l)+Math.abs(c-u)>1&&r[g*e+f]>t?(a(l,u,o,c,f,g),a(h,d,l,u,f,g)):(i[c*e+o]=i[c*e+o]||++n,i[d*e+h]=i[d*e+h]||++n,i[u*e+l]=i[u*e+l]||++n,s++)}i.fill(0),a(0,0,o,o,o,0),a(o,o,0,0,0,o);const c=new Uint16Array(2*n),h=new Uint16Array(3*s);let d=0;function l(n,s,o,a,u,f){const g=n+o>>1,m=s+a>>1;if(Math.abs(n-u)+Math.abs(s-f)>1&&r[m*e+g]>t)l(u,f,n,s,g,m),l(o,a,u,f,g,m);else{const t=i[s*e+n]-1,r=i[a*e+o]-1,l=i[f*e+u]-1;c[2*t]=n,c[2*t+1]=s,c[2*r]=o,c[2*r+1]=a,c[2*l]=u,c[2*l+1]=f,h[d++]=t,h[d++]=r,h[d++]=l}}return l(0,0,o,o,o,0),l(o,o,0,0,0,o),{vertices:c,triangles:h}}}return class{constructor(t=257){this.gridSize=t;const e=t-1;if(e&e-1)throw new Error(`Expected grid size to be 2^n+1, got ${t}.`);this.numTriangles=e*e*2-2,this.numParentTriangles=this.numTriangles-e*e,this.indices=new Uint16Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(4*this.numTriangles);for(let t=0;t<this.numTriangles;t++){let i=t+2,r=0,n=0,s=0,o=0,a=0,c=0;for(1&i?s=o=a=e:r=n=c=e;(i>>=1)>1;){const t=r+s>>1,e=n+o>>1;1&i?(s=r,o=n,r=a,n=c):(r=s,n=o,s=a,o=c),a=t,c=e}const h=4*t;this.coords[h+0]=r,this.coords[h+1]=n,this.coords[h+2]=s,this.coords[h+3]=o}}createTile(e){return new t(e,this)}}});
